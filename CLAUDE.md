# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在处理此代码仓库时提供指导。

## 项目概述

PRISM (Protein Receptor Interaction Simulation Modeler) 是一个用于构建蛋白质-配体系统进行 GROMACS 分子动力学模拟的综合性 Python 工具。支持多种力场，包括 GAFF（通过 AmberTools）和 OpenFF（Open Force Field）。

## 通用开发要求

### 代码质量与规范

- **模块化设计**：每个文件不超过800行代码，保持模块清晰分离
- **使用真实数据**：不使用合成/模拟数据，所有测试应使用真实轨迹数据
- **统一字体格式**：所有输出使用 Times New Roman 字体，确保 PRISM 所有组件格式一致
- **调用 PRISM 接口**：test_*.py 文件应调用 PRISM 公共接口，避免编写复杂逻辑
- **纯 MDTraj 实现**：轨迹分析优先使用 MDTraj，避免混合使用不同库

### 测试与分析要求

- **最小化测试文件**：test_*.py 文件应保持简洁，专注核心功能测试
- **有意义的文件名**：生成的图表文件应使用描述性名称（如 "protein_rmsd_timeseries.png"）
- **避免冗余计算**：移除不必要的分析项目（如配体 RMSF 等）
- **使用公共工具**：配体检测等功能应使用 PRISM 公共工具，避免重复实现

### 性能优化

- **自动并行化**：默认启用多核并行计算，自动检测可用 CPU 核心数
- **OpenMP 优化**：轨迹分析自动启用 OpenMP 并行化，无需额外配置
- **内存效率**：处理大型轨迹时使用生成器和流式处理

### 架构设计

- **高内聚低耦合**：模块间依赖关系清晰，避免循环导入
- **接口稳定**：公共 API 保持向后兼容，内部实现可灵活调整
- **错误处理**：提供详细的错误信息和故障排除指导
- **配置管理**：支持 YAML 配置文件和命令行参数的灵活组合

### 依赖管理

- **推荐使用 mamba**：优先使用 mamba 进行依赖安装，解决依赖冲突
- **隔离环境**：每个项目使用独立的虚拟环境
- **版本锁定**：明确声明依赖版本，确保环境可复现

### 文档与注释

- 代码注释使用English，便于团队理解
- **API 文档**：所有公共接口必须有完整的文档字符串
- **配置说明**：提供详细的配置选项说明和示例

## 开发规范

### 轨迹处理

- **PBC 处理**：使用 MDTraj 进行周期性边界条件校正
- **链选择**：支持复杂的链选择语法（如 "chain P"）
- **配体检测**：使用统一的配体识别工具
- **帧完整性**：确保处理过程中不丢失轨迹帧

### 力场支持

- **多力场兼容**：同时支持 GAFF 和 OpenFF 力场
- **自动检测**：自动检测可用的力场工具
- **错误恢复**：提供备选方案和详细的安装指导

### 图形输出

- **格式统一**：所有图表使用一致的风格和字体
- **文件命名**：使用描述性的文件名，避免通用名称
- **分辨率优化**：确保图表适合出版和展示需求

### 兼容性

- **平台支持**：支持 Linux、macOS（包括 Apple Silicon）
- **Python 版本**：支持 Python 3.9+
- **依赖最小化**：避免不必要的重型依赖

## 安装与配置

详细的安装说明、故障排除指南和配置选项请参考各子模块的具体文档。推荐使用 mamba 进行依赖管理，创建独立的虚拟环境以避免冲突。

## 测试与验证

- 使用真实的蛋白质-配体复合物数据进行测试
- 验证轨迹处理的完整性和准确性
- 确保分析结果的科学合理性
- 检查输出格式的一致性和可读性